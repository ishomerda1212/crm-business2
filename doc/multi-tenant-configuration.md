# マルチテナント展開時の設定項目整理

## 目次
1. [概要](#概要)
2. [優先度別設定項目](#優先度別設定項目)
3. [詳細設定項目](#詳細設定項目)
4. [実装推奨事項](#実装推奨事項)

---

## 概要

本ドキュメントでは、リノベーションCRMアプリケーションをマルチテナント展開する際に、テナント毎にカスタマイズ可能にすべき設定項目を整理します。

### 想定するテナント例
- 異なる建築・リノベーション企業
- フランチャイズ展開企業の各拠点
- 業態が異なる関連企業（新築、リフォーム、不動産など）

---

## 優先度別設定項目

### 【優先度：高】基本設定

#### 1. ブランディング・UI設定
テナントの企業アイデンティティを反映するための基本設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **会社名** | アプリケーション全体に表示される会社名 | "○○リノベーション", "株式会社△△工務店" | Sidebar.tsx:24 |
| **ロゴ画像** | サイドバーとヘッダーに表示されるロゴ | ファイルパスまたはURL | Sidebar.tsx:23-27 |
| **プライマリカラー** | メインブランドカラー（HSL形式） | `0 0% 9%` (黒系), `25 95% 53%` (オレンジ系) | index.css:54 |
| **アクセントカラー** | 強調表示に使用する色 | `25 95% 53%` | index.css:62 |
| **ファビコン** | ブラウザタブに表示されるアイコン | favicon.ico | index.html |
| **アプリケーション名** | ブラウザタイトルに表示 | "○○CRM", "工事管理システム" | index.html:7 |

#### 2. ユーザー・組織マスタ
テナント固有の組織構造とユーザー

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **担当者リスト** | プロジェクトに割当可能な担当者 | ["山田太郎", "佐藤花子", ...] | AssignStaffDialog.tsx:30-35 |
| **店舗・拠点リスト** | 事業所の一覧 | ["本社", "渋谷店", "横浜支店"] | AssignStaffDialog.tsx:38-45 |
| **部門リスト** | 組織の部門構成 | ["営業部", "工事部", "設計部"] | (未実装) |
| **役職リスト** | 承認権限に関連 | ["一般", "主任", "課長", "部長"] | (未実装) |

#### 3. 機能の有効化/無効化
テナントが必要とする機能のみを表示

| 設定項目 | 説明 | デフォルト | 参照箇所 |
|---------|------|-----------|---------|
| **ダッシュボード** | 全体概要表示 | 有効 | Sidebar.tsx:10 |
| **顧客管理** | 顧客情報管理機能 | 有効 | Sidebar.tsx:11 |
| **案件管理** | プロジェクト管理機能 | 有効 | Sidebar.tsx:12 |
| **未収金管理** | 支払い管理機能 | 有効 | Sidebar.tsx:14 |
| **承認管理** | 承認ワークフロー | 有効 | Sidebar.tsx:15 |
| **ランキング** | 営業成績表示 | 有効 | Sidebar.tsx:16 |
| **現場調査同意** | 現場調査プロセス | 有効 | survey-consent/ |
| **契約承認** | 契約承認フロー | 有効 | contract-approval/ |
| **契約手続き** | 契約書作成プロセス | 有効 | contract-procedure/ |
| **追客同意** | 追加営業プロセス | 有効 | ratification-consent/ |
| **変更同意** | 工事変更プロセス | 有効 | change-consent/ |
| **追加発注** | 追加工事発注 | 有効 | additional-order/ |
| **解約同意** | 解約手続き | 有効 | cancellation-consent/ |
| **完工手続き** | 完工処理プロセス | 有効 | completion-procedure/ |
| **コンビニ払込** | コンビニ決済機能 | 有効 | convenience-payment/ |
| **帳票出力** | 各種帳票生成 | 有効 | report-output/ |

---

### 【優先度：高】業務設定

#### 4. 案件ステータス設定
業種や業務フローに応じたステータス定義

| 設定項目 | 説明 | デフォルト値 | 参照箇所 |
|---------|------|------------|---------|
| **ステータスリスト** | 案件の進捗段階 | ["相談", "現調", "契約", "契約手続", "完工", "完工後調査", "記録", "追加発注"] | ProjectStatusSteps.tsx:4-13 |
| **各ステータスの表示色** | 進捗の視覚化 | success, warning, default等 | ProjectStatusSteps.tsx:4-13 |
| **初期ステータス** | 新規案件作成時の状態 | "相談" | (mockData.ts) |

#### 5. プロジェクト分類設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **案件種別** | プロジェクトのタイプ分類 | ["フルリノベ", "部分改修", "新築", "外構工事"] | AssignStaffDialog.tsx:48-53 |
| **工事種別** | 工事の内容分類 | ["内装工事", "外装工事", "設備工事", "解体工事"] | ConstructionTab.tsx |
| **設備分類** | 導入設備のカテゴリ | ["キッチン", "バス", "トイレ", "給湯器", "空調"] | ConstructionDetails型 |

#### 6. 顧客獲得経路設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **獲得チャネルリスト** | 顧客の流入経路 | ["Web", "紹介", "チラシ", "展示会", "電話", "その他"] | CustomerListPage.tsx |

---

### 【優先度：中】ワークフロー設定

#### 7. 契約手続きプロセス
契約締結までの手順をテナント毎にカスタマイズ

| 設定項目 | 説明 | デフォルトステップ | 参照箇所 |
|---------|------|------------------|---------|
| **契約手続きステップ** | 契約プロセスの段階 | 1.同意 → 2.お客様情報 → 3.工事詳細 → 4.重要事項 → 5.保証内容 → 6.契約書 → 7.会社への通知 | contractSteps.ts |
| **各ステップの必須/任意** | ステップのスキップ可否 | すべて必須 (カスタマイズ可) | ContractProcedurePage.tsx |
| **署名収集の有無** | 各ステップでの署名要否 | 最終ステップで必須 | SignatureStep.tsx |

**カスタマイズ例:**
- 簡易契約の場合: 「重要事項」ステップを省略
- 法人向け: 「稟議書添付」ステップを追加
- 高額案件: 「与信審査」ステップを追加

#### 8. 完工手続きプロセス
工事完了から引き渡しまでの手順

| 設定項目 | 説明 | デフォルトステップ | 参照箇所 |
|---------|------|------------------|---------|
| **完工手続きステップ** | 完工プロセスの段階 | 1.工事確認 → 2.保証確認 → 3.精算 → 4.引き渡し → 5.会社への通知 | completionSteps.ts |
| **検査項目** | 完工時のチェック項目 | 施工品質、清掃状態、設備動作等 | CompletionProcedurePage.tsx |
| **引き渡し書類** | 納品時の必要書類 | 保証書、取扱説明書、鍵等 | CompletionInfo型 |

#### 9. 承認フロー設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **契約承認の要否** | 契約時の承認必要性 | 必須 / 任意 / 金額基準 | contract-approval/ |
| **承認金額閾値** | 承認が必要な金額 | 500万円以上、1000万円以上等 | (未実装) |
| **多段階承認** | 複数人による承認 | 1段階(上長のみ) / 2段階(課長→部長) | (未実装) |
| **承認者設定** | 誰が承認可能か | 役職ベース、個人指定等 | (未実装) |
| **コンビニ払込承認** | コンビニ払込の承認要否 | 必須 / 任意 | convenience-payment/ |

#### 10. 追加機能のワークフロー

| 設定項目 | 説明 | 対象機能 | 参照箇所 |
|---------|------|---------|---------|
| **追客同意ステップ** | 追加営業時の同意プロセス | 1.案件情報 → 2.同意 → 3.署名 | ratificationSteps.ts |
| **変更同意ステップ** | 工事内容変更時の同意 | カスタマイズ可能 | changeSteps.ts |
| **追加発注ステップ** | 追加工事発注プロセス | カスタマイズ可能 | additionalOrderSteps.ts |
| **解約同意ステップ** | 解約時の手続き | カスタマイズ可能 | cancellationSteps.ts |

---

### 【優先度：中】契約・見積設定

#### 11. 支払方法設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **利用可能な支払方法** | テナントが対応する決済手段 | ["現金", "銀行振込", "カード払い", "ローン", "リース", "コンビニ払込"] | PaymentMethod型 |
| **分割払い項目** | 工事代金の分割 | ["契約金", "着手金", "中間金", "完工金"] | PaymentMethod型:101-113 |
| **デフォルト支払条件** | 標準的な支払いスケジュール | 契約時30%、着工時30%、完工時40% | (未実装) |

#### 12. 見積・契約書設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **消費税率** | 適用税率 | 10%, 8%(軽減税率対応) | Quotation型:91 |
| **値引き項目の表示** | 値引き額の表示有無 | 表示 / 非表示 | Quotation型:92 |
| **工事保証期間** | デフォルト保証年数 | 1年、2年、5年、10年 | ConstructionDetails型:83 |
| **特記事項テンプレート** | 契約書の定型文言 | テナント固有の契約条項 | ContractInfo型:188-189 |

---

### 【優先度：低】詳細カスタマイズ

#### 13. 物件情報設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **建物構造種別** | 対応する建物タイプ | ["木造", "鉄骨", "RC", "SRC"] | PropertyInfo型:67 |
| **所有形態** | 物件の権利関係 | ["持ち家", "賃貸", "社宅"] | PropertyInfo型:72 |
| **築年数の表示形式** | 築年数の計算・表示 | 築○年、19XX年築 | PropertyInfo型:69 |

#### 14. 帳票・ドキュメント設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **出力可能な帳票種類** | 生成できるドキュメント | ["見積書", "契約書", "請求書", "領収書", "完工報告書"] | report-output/ |
| **帳票テンプレート** | テナント固有のフォーマット | PDFテンプレートファイル | (未実装) |
| **社印・印鑑の画像** | 帳票に押印する画像 | 画像ファイルパス | (未実装) |
| **会社情報** | 帳票フッターに記載 | 住所、電話番号、許可番号等 | (未実装) |

#### 15. ダッシュボード設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **表示するKPI** | ダッシュボードの指標 | ["総案件数", "進行中", "承認待ち", "月次売上", "未収金", "新規顧客"] | DashboardPage.tsx:9-51 |
| **KPIの表示順序** | 指標の並び順 | カスタマイズ可能 | DashboardPage.tsx |
| **グラフの種類** | 可視化の方法 | 棒グラフ、円グラフ、折れ線グラフ | (未実装) |
| **表示期間** | デフォルトの集計期間 | 当月、当四半期、当期 | (未実装) |

#### 16. 通知・アラート設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **メール通知の有効化** | 各種通知メールの送信 | 有効 / 無効 | (未実装) |
| **通知タイミング** | 通知を送るイベント | 承認依頼、支払期限、工程遅延等 | (未実装) |
| **通知テンプレート** | メール本文のテンプレート | テナント固有の文面 | (未実装) |
| **リマインダー設定** | 期限前の通知 | 3日前、1週間前等 | (未実装) |

#### 17. 外部システム連携設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **ANDPAD連携** | 施工管理アプリとの連携 | 有効 / 無効、ANDPAD ID | AssignStaffDialog.tsx:113 |
| **会計システム連携** | 経理システムとの連動 | API設定、連携タイミング | (未実装) |
| **メール送信サービス** | メール配信プロバイダ | SendGrid, AWS SES等 | (未実装) |
| **ストレージサービス** | ファイル保存先 | AWS S3, Azure Blob等 | (未実装) |

#### 18. セキュリティ・アクセス制御

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **ロール(役割)定義** | ユーザーの権限グループ | ["管理者", "営業", "工事担当", "経理", "閲覧のみ"] | (未実装) |
| **機能ごとのアクセス権** | 各機能の利用可否 | ロール別に設定 | (未実装) |
| **データの閲覧範囲** | 見られるデータの制限 | 全社、所属拠点のみ、自分の担当のみ | (未実装) |
| **パスワードポリシー** | パスワードの複雑性要件 | 文字数、複雑度、有効期限 | (未実装) |

---

### 【優先度：低】地域・言語設定

#### 19. ロケール設定

| 設定項目 | 説明 | 設定値例 | 参照箇所 |
|---------|------|---------|---------|
| **言語** | UIの表示言語 | 日本語、英語 | (現在は日本語固定) |
| **日付形式** | 日付の表示フォーマット | "YYYY/MM/DD", "MM/DD/YYYY" | utils.ts |
| **通貨** | 金額の単位と表示 | 円(¥), ドル($) | (現在は円固定) |
| **タイムゾーン** | 日時の扱い | Asia/Tokyo | (未実装) |

#### 20. 業種固有設定

| 設定項目 | 説明 | 設定値例 | 適用業種 |
|---------|------|---------|---------|
| **建設業許可番号** | 帳票等に記載 | "東京都知事許可(般-XX)第XXXXXX号" | 建設業 |
| **宅建業免許番号** | 不動産取引時 | "東京都知事(X)第XXXXX号" | 不動産業 |
| **古物商許可番号** | リユース品扱い時 | "第XXXXXXXXXXX号" | リサイクル業 |

---

## 詳細設定項目

### データモデルへの影響

上記の設定項目を実装する際、以下のデータモデルへの変更が必要になります。

#### 1. テナント設定テーブル (新規作成)
```typescript
type TenantConfig = {
  tenant_id: string;
  tenant_name: string;

  // ブランディング
  branding: {
    company_name: string;
    logo_url: string;
    primary_color: string; // HSL形式
    accent_color: string;
    favicon_url: string;
  };

  // 機能有効化
  enabled_features: {
    dashboard: boolean;
    customers: boolean;
    projects: boolean;
    approvals: boolean;
    // ... 他の機能
  };

  // 業務設定
  business_config: {
    project_statuses: ProjectStatus[];
    project_types: string[];
    acquisition_channels: string[];
    payment_methods: string[];
  };

  // ワークフロー設定
  workflows: {
    contract_procedure_steps: Step[];
    completion_procedure_steps: Step[];
    approval_thresholds: Record<string, number>;
  };

  // 組織マスタ
  organization: {
    staff_list: Staff[];
    store_list: Store[];
    departments: Department[];
  };

  // 外部連携
  integrations: {
    andpad_enabled: boolean;
    accounting_system: string | null;
    // ...
  };
};
```

#### 2. 既存テーブルへの追加

すべての主要テーブルに `tenant_id` カラムを追加し、データの分離を実現:

```typescript
type Project = {
  tenant_id: string; // 追加
  id: string;
  // ... 既存フィールド
};

type Customer = {
  tenant_id: string; // 追加
  id: string;
  // ... 既存フィールド
};

// 他のすべてのエンティティも同様
```

---

## 実装推奨事項

### 1. 実装フェーズの提案

#### フェーズ1: 基礎 (最優先)
- テナントIDの導入とデータ分離
- 基本的なブランディング設定 (会社名、ロゴ、カラー)
- 機能の有効化/無効化
- 担当者・店舗マスタのテナント管理

#### フェーズ2: ワークフロー (高優先)
- 案件ステータスのカスタマイズ
- 契約・完工手続きステップの設定化
- 承認フローの金額閾値設定

#### フェーズ3: 詳細カスタマイズ (中優先)
- 帳票テンプレートのカスタマイズ
- ダッシュボードKPIの選択
- 通知設定
- 外部システム連携

#### フェーズ4: 高度な機能 (低優先)
- ロールベースアクセス制御
- 多言語対応
- 高度なレポート機能

### 2. 技術的な実装アプローチ

#### A. コンテキストプロバイダーパターン
```typescript
// TenantConfigContext.tsx (イメージ)
const TenantConfigContext = createContext<TenantConfig | null>(null);

export const TenantConfigProvider = ({ children }) => {
  const [config, setConfig] = useState<TenantConfig | null>(null);

  useEffect(() => {
    // アプリ起動時にテナント設定を読み込み
    loadTenantConfig().then(setConfig);
  }, []);

  return (
    <TenantConfigContext.Provider value={config}>
      {children}
    </TenantConfigContext.Provider>
  );
};

export const useTenantConfig = () => {
  const config = useContext(TenantConfigContext);
  if (!config) throw new Error('Tenant config not loaded');
  return config;
};
```

#### B. 動的テーマ適用
```typescript
// ThemeLoader.tsx (イメージ)
const ThemeLoader = () => {
  const { branding } = useTenantConfig();

  useEffect(() => {
    // CSS変数を動的に設定
    document.documentElement.style.setProperty('--primary', branding.primary_color);
    document.documentElement.style.setProperty('--accent', branding.accent_color);
  }, [branding]);

  return null;
};
```

#### C. 機能フラグによる条件レンダリング
```typescript
// Sidebar.tsx (改修イメージ)
const Sidebar = () => {
  const { enabled_features } = useTenantConfig();

  return (
    <nav>
      {enabled_features.dashboard && <NavItem to="/dashboard">ダッシュボード</NavItem>}
      {enabled_features.customers && <NavItem to="/customers">顧客管理</NavItem>}
      {enabled_features.projects && <NavItem to="/projects">案件管理</NavItem>}
      {/* ... */}
    </nav>
  );
};
```

#### D. Supabase Row Level Security (RLS)
```sql
-- テナント分離のためのRLSポリシー例
CREATE POLICY "Users can only access their tenant's data"
ON projects
FOR ALL
USING (tenant_id = auth.jwt() ->> 'tenant_id');
```

### 3. 管理画面の必要性

テナント設定を管理するための管理者用UIが必要:

- **スーパー管理者画面**: 全テナントの管理、テナント作成
- **テナント管理者画面**: 自テナントの設定カスタマイズ
  - ブランディング設定
  - 機能有効化
  - マスタデータ管理
  - ワークフロー設定

### 4. マイグレーション戦略

既存データを持つ場合の移行手順:

1. 全テーブルに `tenant_id` カラムを追加
2. 既存データにデフォルトテナントIDを設定
3. RLSポリシーを段階的に適用
4. アプリケーションコードをテナント対応に改修
5. 新規テナントのオンボーディングフローを構築

---

## 参考: 現在のファイル構造と設定箇所マップ

### 設定が影響するファイル一覧

#### UI・ブランディング関連
- `src/components/Sidebar.tsx` - メニュー、ロゴ、会社名
- `src/index.css` - カラーテーマ (CSS変数)
- `tailwind.config.js` - Tailwind設定
- `index.html` - アプリケーション名、ファビコン

#### ワークフロー定義
- `src/features/projects/features/contract-procedure/contractSteps.ts`
- `src/features/projects/features/completion-procedure/completionSteps.ts`
- `src/features/projects/features/ratification-consent/ratificationSteps.ts`
- その他各手続きの `*Steps.ts` ファイル

#### マスタデータ
- `src/features/projects/features/assign-staff/AssignStaffDialog.tsx` - 担当者、店舗、案件種別
- `src/features/projects/components/ProjectStatusSteps.tsx` - ステータス定義
- `src/data/mockData.ts` - 現在のマスタデータ (本番ではDB化)

#### データモデル
- `src/lib/supabase.ts` - 全型定義 (tenant_id追加が必要)

#### ビジネスロジック
- `src/hooks/useProcedure.ts` - 汎用手続きフック
- `src/lib/utils.ts` - ユーティリティ関数

---

## まとめ

### 最重要設定項目 TOP 10

1. **会社名・ロゴ** - ブランドアイデンティティ
2. **プライマリカラー** - 視覚的な統一感
3. **担当者・店舗リスト** - 業務の基本マスタ
4. **機能の有効化/無効化** - 必要な機能のみ提供
5. **案件ステータス定義** - 業務フローの基盤
6. **案件種別** - ビジネス分類
7. **契約手続きステップ** - カスタマイズ頻度が高い
8. **支払方法** - 決済フローに直結
9. **承認金額閾値** - 内部統制に重要
10. **帳票テンプレート** - 対外的な書類

### 推奨する最初のステップ

1. **データモデルの拡張**: 全テーブルに `tenant_id` を追加
2. **テナント設定テーブルの作成**: 上記設定項目を格納
3. **TenantConfigContext の実装**: アプリ全体で設定にアクセス
4. **動的テーマシステム**: CSS変数の動的変更
5. **機能フラグ実装**: メニューと機能の条件表示
6. **管理画面のプロトタイプ**: 設定変更UIの構築

このドキュメントを基に、段階的にマルチテナント対応を進めることで、柔軟でスケーラブルなSaaSアプリケーションへと進化できます。
